<?php
// 2020-01-15 This block is never cached:
// https://github.com/justuno-com/m1/blob/1.4.4/app/design/frontend/base/default/layout/justuno/m1.xml#L5-L20
use Justuno_M1_Settings as S;
use Mage_Customer_Model_Session as SCustomer;
?><script>
	window.ju_num = '<?= S::id() ?>';
	// 2020-01-15 «Validating a GUID in JavaScript» https://stackoverflow.com/a/24573236
	if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(window.ju_num)) {
		delete window.ju_num;
		console.log('JU_ERROR: Justuno Account ID (ACCID) Was Not Set Correctly...');
	}
	else {
		window.ju_ajaxCartURL = '<?= $this->getUrl('jumagext/index/getcart')?>';
		if (location.href.includes('checkout') && location.href.includes('success')) {
		   <?php
				$orderID = Mage::getSingleton('checkout/session')->getLastOrderId();
				$order = Mage::getModel('sales/order')->load($orderID);
			?>
			window.ju_order_id = '<?= $orderID ?>';
			window.ju_order_obj = {
				total: '<?= $order->getGrandTotal() ?>',
				subtotal: '<?= $order->getSubtotal() ?>',
				tax: '<?= $order->getTaxAmount() ?>',
				shipping: '<?= $order->getShippingAmount() ?>',
				currency:'<?= Mage::app()->getStore()->getCurrentCurrencyCode() ?>'
			};
		}
		else {
		  window.ju_cart_obj = {
				total: '<?= Mage::helper('checkout/cart')->getQuote()->getGrandTotal() ?>',
				subtotal: '<?= Mage::helper('checkout/cart')->getQuote()->getSubtotal() ?>',
				tax: '<?= Mage::helper('checkout/cart')->getQuote()->getTaxAmount() ?>',
				shipping: '<?= Mage::helper('checkout/cart')->getQuote()->getShippingAmount() ?>',
				currency: '<?= Mage::app()->getStore()->getCurrentCurrencyCode() ?>'
			};
		}
		window.asset_host = '//cdn.justuno.com/';
		(function (i, s, o, g, r, a, m) {
			i[r] = i[r] || function () {
				(i[r].q = i[r].q || []).push(arguments);
			};
			a = s.createElement(o);
			m = s.getElementsByTagName(o)[0];
			a.async = 1;
			a.src = g;
			m.parentNode.insertBefore(a, m);
		})(window, document, 'script', asset_host + 'vck-m1.js', 'juapp');
	}
</script><?php
if ($url = S::ajaxUrl()) { /** @var string $url */
	?><script>window.ju_MageAJAX = '<?= $url ?>';</script><?php
}
$pageIdentifier = Mage::app()->getFrontController()->getAction()->getFullActionName();
if (Mage::registry('current_product')) {
	$product = Mage::registry('current_product');
	$productid = $product->getId();
	$productstockqty = $product->getStockItem()->getQty();
}
else {
	list($productid, $productstockqty) = [null, null];
}
// 2020-01-15 «How to get Magento customer ID» https://stackoverflow.com/a/17236128
$sCustomer = Mage::getSingleton('customer/session'); /** @var SCustomer $sCustomer */
?>
<script>
	window.ju_MageKeys = {
		PageID: '<?= $pageIdentifier ?>',
		ProductID: '<?= $productid ?>',
		CustomerID: '<?= $sCustomer->getId() ?>',
		StockQty: '<?= $productstockqty ?>'
	};
</script>